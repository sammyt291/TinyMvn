<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Files - TinyMvn</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .header h1 {
      color: white;
      font-size: 20px;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: white;
      color: #667eea;
    }
    
    .btn-primary:hover {
      background: #f0f0f0;
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 12px;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 450px 1fr;
      gap: 12px;
    }
    
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }
    
    .card-header {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-header h2 {
      font-size: 16px;
      color: #333;
    }
    
    .card-body {
      padding: 10px;
    }
    
    /* Upload area */
    .upload-area {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 20px 10px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .upload-area:hover,
    .upload-area.dragover {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .upload-area input {
      display: none;
    }
    
    .upload-icon {
      font-size: 48px;
      margin-bottom: 8px;
    }
    
    .upload-text {
      color: #666;
      margin-bottom: 4px;
    }
    
    .upload-hint {
      color: #999;
      font-size: 12px;
    }
    
    /* Project list */
    .project-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .project-item {
      padding: 6px 8px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .project-item:hover {
      background: #f9fafb;
    }
    
    .project-item.active {
      background: #f0f4ff;
      border-left: 3px solid #667eea;
    }
    
    .project-info h3 {
      font-size: 14px;
      color: #333;
      margin-bottom: 4px;
    }
    
    .project-info p {
      font-size: 12px;
      color: #888;
    }
    
    .project-info .user-badge {
      display: inline-block;
      background: #e0e7ff;
      color: #3730a3;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
    }
    
    .project-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn-icon {
      padding: 6px 10px;
      font-size: 12px;
    }
    
    .empty-state {
      padding: 20px 10px;
      text-align: center;
      color: #888;
    }
    
    /* File tree */
    .file-tree {
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 13px;
    }
    
    .tree-item {
      padding: 6px 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      border-radius: 4px;
    }
    
    .tree-item:hover {
      background: #f5f5f5;
    }
    
    .tree-item.selected {
      background: #e8f0fe;
    }
    
    .tree-folder {
      color: #f59e0b;
    }
    
    .tree-file {
      color: #6b7280;
    }
    
    .tree-children {
      margin-left: 10px;
    }
    
    .tree-toggle {
      width: 16px;
      text-align: center;
      color: #999;
    }
    
    /* File viewer */
    .file-viewer {
      background: #1e1e1e;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .file-viewer-header {
      background: #2d2d2d;
      padding: 6px 8px;
      color: #ccc;
      font-size: 13px;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
    }
    
    .file-viewer-content {
      padding: 8px;
      max-height: 500px;
      overflow: auto;
    }
    
    .file-viewer-content pre {
      color: #d4d4d4;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    /* Progress bar */
    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e5e7eb;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 8px;
      display: none;
    }
    
    .progress-bar.visible {
      display: block;
    }
    
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s;
    }
    
    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateX(400px);
      transition: transform 0.3s ease;
      z-index: 1000;
    }
    
    .notification.visible {
      transform: translateX(0);
    }
    
    .notification.success {
      background: #10b981;
    }
    
    .notification.error {
      background: #ef4444;
    }
    
    .src-main-badge {
      background: #10b981;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }
    
    .github-badge {
      background: #24292e;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }
    
    .branch-badge {
      background: #6e40c9;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 4px;
    }
    
    .btn-github {
      background: #24292e;
      color: white;
    }
    
    .btn-github:hover {
      background: #1b1f23;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>üì¶ TinyMvn</h1>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="window.location.href='/repo'">üì¶ Repository</button>
      <div id="authButtons" class="header-actions">
        <!-- Will be populated based on login status -->
      </div>
    </div>
  </header>
  
  <div class="container">
    <div class="grid">
      <div class="sidebar">
        <!-- Upload Card (visible only when logged in) -->
        <div class="card" id="uploadCard" style="margin-bottom: 12px; display: none;">
          <div class="card-header">
            <h2>Upload Project</h2>
          </div>
          <div class="card-body">
            <div class="upload-area" id="uploadArea">
              <input type="file" id="fileInput" accept=".zip">
              <div class="upload-icon">üìÅ</div>
              <div class="upload-text">Drop ZIP file here or click to upload</div>
              <div class="upload-hint">Supports Java Maven/Gradle projects</div>
            </div>
            <div class="progress-bar" id="progressBar">
              <div class="progress-bar-fill" id="progressFill"></div>
            </div>
            
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
              <div style="display: flex; gap: 4px; align-items: center; margin-bottom: 4px;">
                <span style="font-size: 20px;">üêô</span>
                <span style="font-weight: 500; color: #333;">Clone from GitHub</span>
              </div>
              <div style="display: flex; gap: 4px;" id="githubUrlRow">
                <input type="text" id="githubUrl" placeholder="https://github.com/owner/repo" 
                       style="flex: 1; padding: 10px 14px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                <button class="btn btn-primary" onclick="fetchBranches()" id="fetchBranchesBtn">Fetch Branches</button>
              </div>
              <div id="branchSelector" style="display: none; margin-top: 6px; padding: 6px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; overflow: hidden;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                  <span style="font-size: 13px; color: #666;" id="repoLabel">owner/repo</span>
                  <button onclick="cancelBranchSelect()" style="background: none; border: none; cursor: pointer; font-size: 16px; color: #888;">‚úï</button>
                </div>
                <div style="display: flex; gap: 4px; align-items: center;">
                  <select id="branchSelect" style="flex: 1; min-width: 0; max-width: 100%; padding: 10px 14px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white;">
                    <option value="">Loading branches...</option>
                  </select>
                  <button class="btn btn-primary" onclick="cloneFromGithub()" id="cloneBtn">Clone</button>
                  <button class="btn btn-secondary" style="background: #e5e7eb; color: #666;" onclick="cancelBranchSelect()">Cancel</button>
                </div>
              </div>
              <div style="font-size: 12px; color: #888; margin-top: 3px;" id="githubHint">
                Enter a public GitHub repository URL
              </div>
            </div>
          </div>
        </div>
        
        <!-- Projects Card -->
        <div class="card">
          <div class="card-header">
            <h2>Projects</h2>
            <button class="btn btn-primary btn-icon" onclick="loadProjects()">‚Üª</button>
          </div>
          <div class="card-body" style="padding: 6px 8px; border-bottom: 1px solid #e5e7eb;">
            <input type="text" id="projectSearch" placeholder="üîç Search projects..." 
                   style="width: 100%; padding: 5px 7px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; margin-bottom: 4px;"
                   oninput="filterProjects()">
            <div style="display: flex; gap: 4px; align-items: center;">
              <span style="font-size: 12px; color: #666;">Sort by:</span>
              <select id="projectSort" onchange="sortProjects()" 
                      style="padding: 6px 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; background: white;">
                <option value="date">Date (newest)</option>
                <option value="date-asc">Date (oldest)</option>
                <option value="user">User (A-Z)</option>
                <option value="user-desc">User (Z-A)</option>
                <option value="name">Name (A-Z)</option>
                <option value="name-desc">Name (Z-A)</option>
              </select>
            </div>
          </div>
          <div class="project-list" id="projectList">
            <div class="empty-state">Loading projects...</div>
          </div>
        </div>
      </div>
      
      <div class="main-content">
        <!-- File Browser Card -->
        <div class="card" style="margin-bottom: 12px;">
          <div class="card-header">
            <h2 id="fileTreeTitle">Select a Project</h2>
          </div>
          <div class="card-body">
            <div class="file-tree" id="fileTree">
              <div class="empty-state">Select a project to view its files</div>
            </div>
          </div>
        </div>
        
        <!-- File Viewer Card -->
        <div class="card" id="fileViewerCard" style="display: none;">
          <div class="file-viewer">
            <div class="file-viewer-header" id="fileViewerHeader">file.java</div>
            <div class="file-viewer-content">
              <pre id="fileContent"></pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="notification" id="notification"></div>
  
  <script>
    let currentProject = null;
    let expandedFolders = new Set();
    let allProjects = [];
    let filteredProjects = [];
    let isLoggedIn = false;
    let currentUser = null;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await checkLoginStatus();
      loadProjects();
      if (isLoggedIn) {
        setupUpload();
      }
    });
    
    // Check login status
    async function checkLoginStatus() {
      try {
        const response = await fetch('/files/api/me');
        const data = await response.json();
        
        isLoggedIn = data.loggedIn;
        currentUser = data.user;
        
        updateUIForLoginStatus();
      } catch (err) {
        console.error('Failed to check login status:', err);
        isLoggedIn = false;
        updateUIForLoginStatus();
      }
    }
    
    // Update UI based on login status
    function updateUIForLoginStatus() {
      const authButtons = document.getElementById('authButtons');
      const uploadCard = document.getElementById('uploadCard');
      
      if (isLoggedIn) {
        authButtons.innerHTML = `
          <button class="btn btn-secondary" onclick="window.location.href='/auth/settings'">‚öôÔ∏è Settings</button>
          <button class="btn btn-secondary" onclick="logout()">Logout</button>
        `;
        uploadCard.style.display = 'block';
      } else {
        authButtons.innerHTML = `
          <button class="btn btn-primary" onclick="window.location.href='/auth/login'">Login</button>
        `;
        uploadCard.style.display = 'none';
      }
    }
    
    // Notification helper
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type} visible`;
      
      setTimeout(() => {
        notification.classList.remove('visible');
      }, 4000);
    }
    
    // Setup upload functionality
    function setupUpload() {
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');
      
      uploadArea.addEventListener('click', () => fileInput.click());
      
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        if (e.dataTransfer.files.length > 0) {
          handleUpload(e.dataTransfer.files[0]);
        }
      });
      
      fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
          handleUpload(fileInput.files[0]);
        }
      });
    }
    
    // Handle file upload
    async function handleUpload(file) {
      if (!file.name.endsWith('.zip')) {
        showNotification('Please upload a ZIP file', 'error');
        return;
      }
      
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      
      progressBar.classList.add('visible');
      progressFill.style.width = '0%';
      
      const formData = new FormData();
      formData.append('file', file);
      
      try {
        const xhr = new XMLHttpRequest();
        
        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const percent = (e.loaded / e.total) * 100;
            progressFill.style.width = percent + '%';
          }
        };
        
        xhr.onload = () => {
          progressBar.classList.remove('visible');
          
          if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            showNotification(response.message);
            loadProjects();
          } else {
            const error = JSON.parse(xhr.responseText);
            showNotification(error.error || 'Upload failed', 'error');
          }
        };
        
        xhr.onerror = () => {
          progressBar.classList.remove('visible');
          showNotification('Upload failed', 'error');
        };
        
        xhr.open('POST', '/files/api/upload');
        xhr.send(formData);
      } catch (err) {
        progressBar.classList.remove('visible');
        showNotification('Upload failed: ' + err.message, 'error');
      }
    }
    
    // Load projects
    async function loadProjects() {
      try {
        const response = await fetch('/files/api/projects');
        const data = await response.json();
        
        allProjects = data.projects || [];
        sortProjects();
      } catch (err) {
        console.error('Failed to load projects:', err);
        showNotification('Failed to load projects', 'error');
      }
    }
    
    // Sort projects
    function sortProjects() {
      const sortBy = document.getElementById('projectSort').value;
      
      filteredProjects = [...allProjects];
      
      switch (sortBy) {
        case 'date':
          filteredProjects.sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));
          break;
        case 'date-asc':
          filteredProjects.sort((a, b) => new Date(a.uploadedAt) - new Date(b.uploadedAt));
          break;
        case 'user':
          filteredProjects.sort((a, b) => (a.uploadedBy || '').localeCompare(b.uploadedBy || ''));
          break;
        case 'user-desc':
          filteredProjects.sort((a, b) => (b.uploadedBy || '').localeCompare(a.uploadedBy || ''));
          break;
        case 'name':
          filteredProjects.sort((a, b) => a.name.localeCompare(b.name));
          break;
        case 'name-desc':
          filteredProjects.sort((a, b) => b.name.localeCompare(a.name));
          break;
      }
      
      filterProjects();
    }
    
    // Filter projects by search
    function filterProjects() {
      const searchTerm = document.getElementById('projectSearch').value.toLowerCase().trim();
      const projectList = document.getElementById('projectList');
      
      let projects = filteredProjects;
      
      if (searchTerm) {
        projects = filteredProjects.filter(project => 
          project.name.toLowerCase().includes(searchTerm) ||
          (project.uploadedBy || '').toLowerCase().includes(searchTerm) ||
          (project.originalFilename || '').toLowerCase().includes(searchTerm)
        );
      }
      
      if (projects.length === 0) {
        if (allProjects.length === 0) {
          projectList.innerHTML = '<div class="empty-state">No projects yet. Upload a ZIP file to get started.</div>';
        } else {
          projectList.innerHTML = '<div class="empty-state">No projects match your search.</div>';
        }
        return;
      }
      
      projectList.innerHTML = projects.map(project => `
        <div class="project-item ${currentProject === project.name ? 'active' : ''}" 
             onclick="selectProject('${project.name}')">
          <div class="project-info">
            <h3>
              ${project.name}
              ${project.srcMainPath ? '<span class="src-main-badge">src/main</span>' : ''}
              ${project.githubUrl ? '<span class="github-badge">üêô GitHub</span>' : ''}
              ${project.githubBranch ? `<span class="branch-badge">${project.githubBranch}</span>` : ''}
            </h3>
            <p>
              ${new Date(project.uploadedAt).toLocaleString()}
              <span class="user-badge">üë§ ${project.uploadedBy || 'unknown'}</span>
            </p>
          </div>
          ${isLoggedIn ? `
          <div class="project-actions">
            ${project.githubUrl ? `<button class="btn btn-github btn-icon" onclick="event.stopPropagation(); updateFromGithub('${project.name}')" title="Update from GitHub (${project.githubBranch || 'main'})">‚Üª</button>` : ''}
            <button class="btn btn-danger btn-icon" onclick="event.stopPropagation(); deleteProject('${project.name}')">√ó</button>
          </div>
          ` : ''}
        </div>
      `).join('');
    }
    
    // Select project
    async function selectProject(name) {
      // Only clear expanded folders when switching to a different project
      if (currentProject !== name) {
        expandedFolders.clear();
      }
      currentProject = name;
      
      try {
        const response = await fetch(`/files/api/projects/${name}`);
        const data = await response.json();
        
        document.getElementById('fileTreeTitle').textContent = name;
        document.getElementById('fileTree').innerHTML = renderTree(data.files);
        document.getElementById('fileViewerCard').style.display = 'none';
        
    // Update active state in project list
    document.querySelectorAll('.project-item').forEach(item => {
      item.classList.remove('active');
    });
    event?.target?.closest('.project-item')?.classList.add('active');
        
        filterProjects(); // Refresh to show active state
      } catch (err) {
        console.error('Failed to load project:', err);
        showNotification('Failed to load project files', 'error');
      }
    }
    
    // Render file tree
    function renderTree(items, parentPath = '') {
      return items.map(item => {
        const fullPath = parentPath ? `${parentPath}/${item.name}` : item.name;
        
        if (item.isDirectory) {
          const isExpanded = expandedFolders.has(fullPath);
          return `
            <div class="tree-node">
              <div class="tree-item" onclick="toggleFolder('${fullPath}')">
                <span class="tree-toggle">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                <span class="tree-folder">üìÅ</span>
                ${item.name}
              </div>
              <div class="tree-children" style="display: ${isExpanded ? 'block' : 'none'}">
                ${item.children ? renderTree(item.children, fullPath) : ''}
              </div>
            </div>
          `;
        } else {
          const icon = getFileIcon(item.name);
          return `
            <div class="tree-item" onclick="viewFile('${fullPath}')">
              <span class="tree-toggle"></span>
              <span class="tree-file">${icon}</span>
              ${item.name}
            </div>
          `;
        }
      }).join('');
    }
    
    // Get file icon
    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const icons = {
        'java': '‚òï',
        'xml': 'üìÑ',
        'json': 'üìã',
        'properties': '‚öôÔ∏è',
        'md': 'üìù',
        'txt': 'üìÑ',
        'gradle': 'üêò',
        'yml': 'üìã',
        'yaml': 'üìã'
      };
      return icons[ext] || 'üìÑ';
    }
    
    // Toggle folder
    function toggleFolder(path) {
      if (expandedFolders.has(path)) {
        expandedFolders.delete(path);
      } else {
        expandedFolders.add(path);
      }
      selectProject(currentProject);
    }
    
    // View file
    async function viewFile(filePath) {
      if (!currentProject) return;
      
      try {
        const response = await fetch(`/files/api/projects/${currentProject}/file?path=${encodeURIComponent(filePath)}`);
        const data = await response.json();
        
        const fileViewerCard = document.getElementById('fileViewerCard');
        const fileViewerHeader = document.getElementById('fileViewerHeader');
        const fileContent = document.getElementById('fileContent');
        
        fileViewerHeader.textContent = filePath + (data.size ? ` (${data.size})` : '');
        
        if (data.content !== null) {
          fileContent.textContent = data.content;
        } else {
          fileContent.textContent = data.message || 'Unable to display file';
        }
        
        fileViewerCard.style.display = 'block';
        
        // Highlight selected
        document.querySelectorAll('.tree-item').forEach(item => {
          item.classList.remove('selected');
        });
        event?.target?.closest('.tree-item')?.classList.add('selected');
      } catch (err) {
        console.error('Failed to view file:', err);
        showNotification('Failed to load file', 'error');
      }
    }
    
    // Delete project
    async function deleteProject(name) {
      if (!confirm(`Are you sure you want to delete "${name}"?`)) {
        return;
      }
      
      try {
        const response = await fetch(`/files/api/projects/${name}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showNotification('Project deleted');
          if (currentProject === name) {
            currentProject = null;
            document.getElementById('fileTreeTitle').textContent = 'Select a Project';
            document.getElementById('fileTree').innerHTML = '<div class="empty-state">Select a project to view its files</div>';
            document.getElementById('fileViewerCard').style.display = 'none';
          }
          loadProjects();
        } else {
          const data = await response.json();
          showNotification(data.error || 'Failed to delete project', 'error');
        }
      } catch (err) {
        console.error('Failed to delete project:', err);
        showNotification('Failed to delete project', 'error');
      }
    }
    
    // Fetch branches from GitHub
    let selectedGithubUrl = '';
    
    async function fetchBranches() {
      const urlInput = document.getElementById('githubUrl');
      const fetchBtn = document.getElementById('fetchBranchesBtn');
      const url = urlInput.value.trim();
      
      if (!url) {
        showNotification('Please enter a GitHub URL', 'error');
        return;
      }
      
      // Basic validation
      if (!url.match(/^https?:\/\/(www\.)?github\.com\/[\w.-]+\/[\w.-]+/)) {
        showNotification('Invalid GitHub URL. Use format: https://github.com/owner/repo', 'error');
        return;
      }
      
      fetchBtn.disabled = true;
      fetchBtn.textContent = 'Loading...';
      
      try {
        const response = await fetch('/files/api/github/branches', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          selectedGithubUrl = url;
          showBranchSelector(data);
        } else {
          showNotification(data.error || 'Failed to fetch branches', 'error');
        }
      } catch (err) {
        showNotification('Failed to fetch branches: ' + err.message, 'error');
      } finally {
        fetchBtn.disabled = false;
        fetchBtn.textContent = 'Fetch Branches';
      }
    }
    
    function showBranchSelector(data) {
      const branchSelector = document.getElementById('branchSelector');
      const branchSelect = document.getElementById('branchSelect');
      const repoLabel = document.getElementById('repoLabel');
      const urlRow = document.getElementById('githubUrlRow');
      const hint = document.getElementById('githubHint');
      
      // Update repo label
      repoLabel.textContent = `${data.owner}/${data.repo}`;
      
      // Populate branch dropdown
      branchSelect.innerHTML = data.branches.map(branch => 
        `<option value="${branch}" ${branch === data.defaultBranch ? 'selected' : ''}>${branch}${branch === data.defaultBranch ? ' (default)' : ''}</option>`
      ).join('');
      
      // Show branch selector, hide URL row
      urlRow.style.display = 'none';
      branchSelector.style.display = 'block';
      hint.style.display = 'none';
    }
    
    function cancelBranchSelect() {
      const branchSelector = document.getElementById('branchSelector');
      const urlRow = document.getElementById('githubUrlRow');
      const hint = document.getElementById('githubHint');
      
      branchSelector.style.display = 'none';
      urlRow.style.display = 'flex';
      hint.style.display = 'block';
      selectedGithubUrl = '';
    }
    
    // Clone from GitHub
    async function cloneFromGithub() {
      const cloneBtn = document.getElementById('cloneBtn');
      const branchSelect = document.getElementById('branchSelect');
      const branch = branchSelect.value;
      
      if (!selectedGithubUrl || !branch) {
        showNotification('Please select a branch', 'error');
        return;
      }
      
      cloneBtn.disabled = true;
      cloneBtn.textContent = 'Cloning...';
      
      try {
        const response = await fetch('/files/api/clone', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: selectedGithubUrl, branch })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showNotification(data.message || 'Repository cloned successfully');
          document.getElementById('githubUrl').value = '';
          cancelBranchSelect();
          loadProjects();
        } else {
          showNotification(data.error || 'Failed to clone repository', 'error');
        }
      } catch (err) {
        showNotification('Failed to clone repository: ' + err.message, 'error');
      } finally {
        cloneBtn.disabled = false;
        cloneBtn.textContent = 'Clone';
      }
    }
    
    // Update project from GitHub
    async function updateFromGithub(projectName) {
      if (!confirm(`Update "${projectName}" from GitHub? This will replace all files with the latest from the repository.`)) {
        return;
      }
      
      showNotification('Updating from GitHub...', 'success');
      
      try {
        const response = await fetch(`/files/api/projects/${projectName}/update`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showNotification(data.message || 'Project updated successfully');
          loadProjects();
          if (currentProject === projectName) {
            selectProject(projectName);
          }
        } else {
          showNotification(data.error || 'Failed to update project', 'error');
        }
      } catch (err) {
        showNotification('Failed to update project: ' + err.message, 'error');
      }
    }
    
    // Handle Enter key in GitHub URL input
    document.addEventListener('DOMContentLoaded', () => {
      const githubInput = document.getElementById('githubUrl');
      if (githubInput) {
        githubInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            fetchBranches();
          }
        });
      }
    });
    
    // Logout
    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.reload();
      } catch (err) {
        window.location.href = '/auth/logout';
      }
    }
  </script>
</body>
</html>
